/*!build time : 2013-11-09 8:39:33 PM*/
KISSY.add("gallery/spotlight/1.3/index",function(a,b,c,d){function e(b){var c=this.constructor;for(b=b||{};c;)b.maskPadding&&(b.maskPadding=this._initMaskPadding(b.maskPadding)),b=a.merge(c.Config,b),c=c.superclass?c.superclass.constructor:null;this.config=b,this.queue=b.queue||[],delete b.queue,this.masks=["top","right","bottom","left"],this.isMasked=!1,this._init()}var f="nextFocus",g="prevFocus",h="hide",i="render",j="focusTo",k=e.Config={zIndex:9999,bgColor:"#000",opacity:.5,maskCls:"spotlight-mask",maskPadding:{top:0,bottom:0,left:0,right:0},anim:{duration:.2},initIndex:0,lazyInit:!0,clickOnHide:!0,lastOnEnd:!0,resizeBuffer:50,clickOnHideTip:"",toggleOnAnim:!1,focusBorder:null,listeners:null};return a.augment(e,a.EventTarget,{_init:function(){this._initEvent()},_initEvent:function(){var b=this.config.listeners;b&&a.each(b,function(c,d){a.isFunction(c)&&this.on(d,c,b.scope||this)},this)},_onRender:function(){var a=this,d=document,e=d.createElement("div"),f=d.createElement("div"),g=d.createElement("div"),h=d.createElement("div"),j=d.createDocumentFragment(),k=a.config,l=k.maskCls;if(j.appendChild(f),j.appendChild(e),j.appendChild(g),j.appendChild(h),e.title=f.title=g.title=h.title=k.clickOnHideTip,e.style.position=f.style.position=g.style.position=h.style.position="absolute",e.style.backgroundColor=f.style.backgroundColor=g.style.backgroundColor=h.style.backgroundColor=k.bgColor,e.style.opacity=f.style.opacity=g.style.opacity=h.style.opacity=k.opacity,e.style.filter=f.style.filter=g.style.filter=h.style.filter="alpha(opacity="+100*parseFloat(k.opacity)+")",e.style.zIndex=f.style.zIndex=g.style.zIndex=h.style.zIndex=k.zIndex,e.className=f.className=g.className=h.className=l,e.className+=" "+l+"-left",f.className+=" "+l+"-top",g.className+=" "+l+"-right",h.className+=" "+l+"-bottom",g.style.top=g.style.right=h.style.right=h.style.bottom=e.style.left=e.style.bottom=f.style.left=f.style.top=0,k.focusBorder){var m=this.border=document.createElement("div");m.className=l+"-border",m.style.border=k.focusBorder.borderStyle,m.style.position="absolute",m.style.zIndex=k.zIndex+1,m.style.top=-9999,j.appendChild(m)}b.append(j,d.body),this.fire(i),a.left=e,a.top=f,a.right=g,a.bottom=h,k.clickOnHide===!0&&c.delegate(d.body,"click","."+k.maskCls,a.hide,a),c.on(window,"resize",this._onResize,this)},_initMaskPadding:function(b){return b=a.isNumber(b)||a.isString(b)?{top:b,left:b,bottom:b,right:b}:a.isPlainObject(b)?a.merge(a.clone(k.maskPadding),b):a.clone(this.config.maskPadding||k.maskPadding)},_getInlineConfig:function(c){var e=b.attr(c,"data-config");try{e=e.replace(/'/g,'"'),e=d.parse(e)}catch(f){e={}}return e.maskPadding&&(e.maskPadding=this._initMaskPadding(e.maskPadding)),a.merge(a.clone(this.config||k),e)},_reloadMaskStyle:function(c){c.bgColor&&(c.backgroundColor=c.bgColor),c.opacity&&(c.filter="alpha(opacity="+100*parseFloat(c.opacity)+")"),a.each(this.masks,function(a){b.css(this[a],c)},this)},_onResize:function(){this.resizeTimer&&this.resizeTimer.cancel(),this.resizeTimer=a.later(function(){if(this.isMasked){var c=this.queue[this.currentIndex].node,d=this._getInlineConfig(c);this._reloadMaskStyle(d);var e=this._getMaskBoxSize(c,d.maskPadding);a.each(this.masks,function(a){b.css(this[a],e[a])},this)}},this.config.resizeBuffer,!1,this)},_unmask:function(){this._alignToBox({top:{height:0},bottom:{height:0},right:{width:0},left:{width:0}},this.config.anim.duration),this.isMasked=!1,this.border&&(this.border.style.top=-9999)},_getMaskBoxSize:function(a,c){var d=b.offset(a),e=c||this.config.maskPadding,f=b.outerHeight(a),g=b.outerWidth(a),h=d.top-e.top,i=d.left-e.left,j=b.docWidth(),k=b.docHeight(),l=j-(g+i)-e.right-e.left,m=k-(f+h)-e.top-e.bottom;return this.offset={left:i,top:h,width:g+e.left+e.right,height:f+e.top+e.bottom},{top:{height:h,width:i+g+e.left+e.right},left:{height:k-h,width:i,top:h},right:{width:l,height:h+f+e.top+e.bottom},bottom:{height:m,width:j-i,top:h+f+e.top+e.bottom}}},_alignToBox:function(c,d){if(this.rendered){var e;if(e=0===d||d===!1?function(a){b.css(this[a],c[a])}:function(b){a.Anim(this[b],c[b],d).run()},a.each(this.masks,e,this),this.border){var f=this.queue[this.currentIndex].node,g=b.offset(f),h={height:b.height(f),width:b.width(f)};b.css(this.border,{height:h.height,width:h.width,top:g.top,left:g.left})}this.isMasked=!0,this.border&&this.config.focusBorder.focusOnBlink&&this._applyBlinkBorder()}},_applyBlinkBorder:function(){this._cancelBlinkBorder();var b,c=this,d=c.config,e=this.border.style.top,f="-9999px";this.border.style.display="block",this.borderBlinkTimer=a.later(function(){b=this.border.style.top,this.border.style.top=b==e?f:e},d.focusBorder.interval,!0,this),d.focusBorder.blinkTime&&(this.borderBlinkStopTimer=a.later(function(){this._cancelBlinkBorder()},d.focusBorder.blinkTime,!1,this))},_cancelBlinkBorder:function(){this.borderBlinkTimer&&(this.borderBlinkTimer.cancel(),delete this.borderBlinkTimer),this.borderBlinkStopTimer&&(this.borderBlinkStopTimer.cancel(),delete this.borderBlinkStopTimer),this.border&&(this.border.style.display="none")},canNext:function(){return!!this.queue[this.currentIndex+1]},canPrevious:function(){return!!this.queue[this.currentIndex-1]},hide:function(){this._unmask(),this.fire(h),this._cancelBlinkBorder()},end:function(){this.currentIndex=0,this.hide()},start:function(){var b=a.isNumber(this.config.initIndex)?this.config.initIndex:this.currentIndex;this.queue[b]&&(this.currentIndex=b,this.focusTo(b,!0),delete this.config.initIndex)},nextFocus:function(){var a=this.currentIndex+1;this.queue[a]&&(this.currentIndex=a,this.fire(f,{nodeTarget:this.queue[a]}),this.focusTo(this.currentIndex,this.config.toggleOnAnim))},prevFocus:function(){var a=this.currentIndex-1;this.queue[a]&&(this.currentIndex=a,this.fire(g,{nodeTarget:this.queue[a]}),this.focusTo(this.currentIndex,this.config.toggleOnAnim))},focusTo:function(c,d){if(this.rendered!==!0&&(this._onRender(),this.rendered=!0),this.queue[c]){this.currentIndex=c;var e=this.queue[c].node,f=this._getInlineConfig(e);this._reloadMaskStyle(f);var g=this,h=b.height(e),i=g._getMaskBoxSize(e,f.maskPadding),k=b.offset(e),l=k.top,m=b.viewportHeight(),n=b.scrollTop(),o=l>m+n;(o||n>h+l)&&a.one(window).animate({scrollTop:l-h},.2),g._alignToBox(i,d?g.config.anim.duration:!1),this.fire(j,{nodeTarget:e,offset:k,index:c})}},addFocus:function(a){this.queue.push(a)},removeFocus:function(a){this.queue.splice(a,1)},destroy:function(){this.hide(),a.later(function(){b.remove([this.top,this.left,this.right,this.bottom,this.border]),this.top=this.left=this.right=this.bottom=this.border=null},500,!1,this)},getTarget:function(){return this.isMasked&&this.queue[this.currentIndex]?this.queue[this.currentIndex].node:null}}),e},{requires:["dom","event","json"]});